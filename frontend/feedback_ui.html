<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP åé¦ˆæ”¶é›†å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .chat-container {
            display: flex;
            height: 70vh;
        }

        .messages-panel {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .message.agent {
            background: #e0e7ff;
            border-left: 4px solid #4f46e5;
        }

        .message.user {
            background: #dcfce7;
            border-left: 4px solid #22c55e;
            margin-left: 40px;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
        }

        .message-header .icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 50%;
        }

        .agent-icon {
            background: #4f46e5;
        }

        .user-icon {
            background: #22c55e;
        }

        .message-content {
            line-height: 1.6;
            color: #1f2937;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 16px 0 8px 0;
            color: #111827;
        }

        .message-content pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .message-content code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .input-panel {
            width: 400px;
            background: white;
            border-left: 1px solid #e5e7eb;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .text-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 12px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }

        .file-upload-label:hover {
            border-color: #4f46e5;
            background: #f8fafc;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .file-item span {
            font-size: 14px;
            color: #374151;
        }

        .file-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }

            .input-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– MCP åé¦ˆæ”¶é›†å™¨</h1>
            <p>æ™ºèƒ½åŠ©æ‰‹ä¸ç”¨æˆ·çš„å®æ—¶äº¤äº’å¹³å°</p>
        </div>

        <div class="chat-container">
            <div class="messages-panel" id="messagesPanel">
                <div class="message agent">
                    <div class="message-header">
                        <div class="icon agent-icon"></div>
                        <span>AI åŠ©æ‰‹</span>
                    </div>
                    <div class="message-content" id="agentMessage">
                        <p>æ­£åœ¨ç­‰å¾…ä»»åŠ¡ä¿¡æ¯...</p>
                    </div>
                </div>
            </div>

            <div class="input-panel">
                <div class="input-section">
                    <label for="feedbackText">ğŸ“ æ‚¨çš„åé¦ˆ</label>
                    <textarea 
                        id="feedbackText" 
                        class="text-input" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„åé¦ˆã€å»ºè®®æˆ–å›ç­”...\n\næ”¯æŒ Markdown æ ¼å¼ï¼š\n- **ç²—ä½“æ–‡æœ¬**\n- *æ–œä½“æ–‡æœ¬*\n- `ä»£ç ç‰‡æ®µ`\n- [é“¾æ¥](URL)\n- åˆ—è¡¨é¡¹"
                    ></textarea>
                </div>

                <div class="input-section">
                    <label>ğŸ–¼ï¸ å›¾ç‰‡ä¸Šä¼ </label>
                    <div class="file-upload">
                        <input type="file" id="imageUpload" accept="image/*" multiple>
                        <label for="imageUpload" class="file-upload-label">
                            ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
                        </label>
                    </div>
                    <div id="imageList" class="file-list"></div>
                </div>

                <div class="input-section">
                    <label>ğŸ“ æ–‡ä»¶ä¸Šä¼ </label>
                    <div class="file-upload">
                        <input type="file" id="fileUpload" multiple>
                        <label for="fileUpload" class="file-upload-label">
                            ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶
                        </label>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>

                <button id="submitBtn" class="submit-btn">ğŸš€ æäº¤åé¦ˆ</button>
                <div id="status" class="status" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½® marked å’Œ highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // å…¨å±€å˜é‡
        let uploadedImages = [];
        let uploadedFiles = [];
        let sessionId = null;
        let ws = null;

        // DOM å…ƒç´ 
        const messagesPanel = document.getElementById('messagesPanel');
        const agentMessage = document.getElementById('agentMessage');
        const feedbackText = document.getElementById('feedbackText');
        const imageUpload = document.getElementById('imageUpload');
        const fileUpload = document.getElementById('fileUpload');
        const imageList = document.getElementById('imageList');
        const fileList = document.getElementById('fileList');
        const submitBtn = document.getElementById('submitBtn');
        const status = document.getElementById('status');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSession();
            setupEventListeners();
        });

        // åˆå§‹åŒ–ä¼šè¯
        function initializeSession() {
            // ä» URL å‚æ•°è·å–ä¼šè¯ID
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session') || generateSessionId();
            
            // å»ºç«‹ WebSocket è¿æ¥
            connectWebSocket();
            
            // åŠ è½½åˆå§‹æ¶ˆæ¯
            loadInitialMessage();
        }

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // å»ºç«‹ WebSocket è¿æ¥
        function connectWebSocket() {
            try {
                ws = new WebSocket(`ws://localhost:8001/ws/${sessionId}`);
                
                ws.onopen = function() {
                    showStatus('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onclose = function() {
                    showStatus('è¿æ¥å·²æ–­å¼€', 'error');
                };
                
                ws.onerror = function() {
                    showStatus('è¿æ¥é”™è¯¯', 'error');
                };
            } catch (error) {
                showStatus('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        // å¤„ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(data) {
            if (data.type === 'agent_message') {
                updateAgentMessage(data.content);
            } else if (data.type === 'session_complete') {
                showStatus('ä¼šè¯å·²å®Œæˆ', 'success');
                submitBtn.disabled = true;
            }
        }

        // åŠ è½½åˆå§‹æ¶ˆæ¯
        function loadInitialMessage() {
            // æ¨¡æ‹Ÿä»æœåŠ¡å™¨è·å–åˆå§‹æ¶ˆæ¯
            const mockMessage = `# ğŸ¤– ä»»åŠ¡æ‰§è¡Œä¸­

æˆ‘æ­£åœ¨æ‰§è¡Œæ‚¨çš„ä»»åŠ¡ï¼Œé‡åˆ°äº†ä¸€äº›éœ€è¦ç¡®è®¤çš„é—®é¢˜ï¼š

## ğŸ“‹ å½“å‰çŠ¶æ€
- âœ… é¡¹ç›®ç»“æ„åˆ†æå®Œæˆ
- âœ… ä¾èµ–å…³ç³»æ£€æŸ¥å®Œæˆ
- â³ ä»£ç ç”Ÿæˆè¿›è¡Œä¸­

## â“ éœ€è¦æ‚¨çš„åé¦ˆ

1. **ä»£ç é£æ ¼åå¥½**ï¼šæ‚¨å¸Œæœ›ä½¿ç”¨å“ªç§ä»£ç é£æ ¼ï¼Ÿ
   - é€‰é¡¹Aï¼šç®€æ´é£æ ¼
   - é€‰é¡¹Bï¼šè¯¦ç»†æ³¨é‡Šé£æ ¼

2. **åŠŸèƒ½ä¼˜å…ˆçº§**ï¼šä»¥ä¸‹åŠŸèƒ½çš„å®ç°ä¼˜å…ˆçº§å¦‚ä½•æ’åºï¼Ÿ
   - ç”¨æˆ·è®¤è¯
   - æ•°æ®å¯è§†åŒ–
   - æ€§èƒ½ä¼˜åŒ–

è¯·åœ¨å³ä¾§é¢æ¿ä¸­æä¾›æ‚¨çš„åé¦ˆï¼Œæ”¯æŒä¸Šä¼ ç›¸å…³å›¾ç‰‡æˆ–æ–‡ä»¶ã€‚`;
            
            updateAgentMessage(mockMessage);
        }

        // æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯
        function updateAgentMessage(content) {
            agentMessage.innerHTML = marked.parse(content);
            // é«˜äº®ä»£ç å—
            agentMessage.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å›¾ç‰‡ä¸Šä¼ 
            imageUpload.addEventListener('change', handleImageUpload);
            
            // æ–‡ä»¶ä¸Šä¼ 
            fileUpload.addEventListener('change', handleFileUpload);
            
            // æäº¤æŒ‰é’®
            submitBtn.addEventListener('click', submitFeedback);
            
            // æ‹–æ‹½ä¸Šä¼ 
            setupDragAndDrop();
            
            // é”®ç›˜å¿«æ·é”®
            feedbackText.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    submitFeedback();
                }
            });
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };
                        uploadedImages.push(imageData);
                        displayImagePreview(imageData);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    uploadedFiles.push(fileData);
                    displayFileItem(fileData);
                };
                reader.readAsDataURL(file);
            });
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function displayImagePreview(imageData) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <div>
                    <span>${imageData.name}</span>
                    <img src="${imageData.data}" class="image-preview" alt="é¢„è§ˆ">
                </div>
                <button class="file-remove" onclick="removeImage('${imageData.name}')">åˆ é™¤</button>
            `;
            imageList.appendChild(item);
        }

        // æ˜¾ç¤ºæ–‡ä»¶é¡¹
        function displayFileItem(fileData) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <span>${fileData.name} (${formatFileSize(fileData.size)})</span>
                <button class="file-remove" onclick="removeFile('${fileData.name}')">åˆ é™¤</button>
            `;
            fileList.appendChild(item);
        }

        // åˆ é™¤å›¾ç‰‡
        function removeImage(fileName) {
            uploadedImages = uploadedImages.filter(img => img.name !== fileName);
            refreshImageList();
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            refreshFileList();
        }

        // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
        function refreshImageList() {
            imageList.innerHTML = '';
            uploadedImages.forEach(displayImagePreview);
        }

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        function refreshFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach(displayFileItem);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const uploadAreas = document.querySelectorAll('.file-upload-label');
            
            uploadAreas.forEach(area => {
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#4f46e5';
                    this.style.background = '#f8fafc';
                });
                
                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#d1d5db';
                    this.style.background = '';
                });
                
                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#d1d5db';
                    this.style.background = '';
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (this.getAttribute('for') === 'imageUpload') {
                        handleDroppedImages(files);
                    } else {
                        handleDroppedFiles(files);
                    }
                });
            });
        }

        // å¤„ç†æ‹–æ‹½çš„å›¾ç‰‡
        function handleDroppedImages(files) {
            files.filter(file => file.type.startsWith('image/')).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    uploadedImages.push(imageData);
                    displayImagePreview(imageData);
                };
                reader.readAsDataURL(file);
            });
        }

        // å¤„ç†æ‹–æ‹½çš„æ–‡ä»¶
        function handleDroppedFiles(files) {
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    uploadedFiles.push(fileData);
                    displayFileItem(fileData);
                };
                reader.readAsDataURL(file);
            });
        }

        // æäº¤åé¦ˆ
        function submitFeedback() {
            const feedback = feedbackText.value.trim();
            
            if (!feedback && uploadedImages.length === 0 && uploadedFiles.length === 0) {
                showStatus('è¯·è¾“å…¥åé¦ˆå†…å®¹æˆ–ä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }
            
            const feedbackData = {
                sessionId: sessionId,
                text: feedback,
                images: uploadedImages,
                files: uploadedFiles,
                timestamp: new Date().toISOString()
            };
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addUserMessage(feedback, uploadedImages, uploadedFiles);
            
            // å‘é€åˆ°æœåŠ¡å™¨
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'user_feedback',
                    data: feedbackData
                }));
                showStatus('åé¦ˆå·²å‘é€', 'success');
            } else {
                // æ¨¡æ‹Ÿå‘é€æˆåŠŸ
                setTimeout(() => {
                    showStatus('åé¦ˆå·²å‘é€ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰', 'info');
                }, 500);
            }
            
            // æ¸…ç©ºè¾“å…¥
            clearInputs();
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©é¢æ¿
        function addUserMessage(text, images, files) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            let content = `
                <div class="message-header">
                    <div class="icon user-icon"></div>
                    <span>æ‚¨</span>
                </div>
                <div class="message-content">
            `;
            
            if (text) {
                content += marked.parse(text);
            }
            
            if (images.length > 0) {
                content += '<div style="margin-top: 10px;"><strong>ğŸ“· ä¸Šä¼ çš„å›¾ç‰‡ï¼š</strong></div>';
                images.forEach(img => {
                    content += `<img src="${img.data}" style="max-width: 200px; margin: 5px; border-radius: 4px;" alt="${img.name}">`;
                });
            }
            
            if (files.length > 0) {
                content += '<div style="margin-top: 10px;"><strong>ğŸ“ ä¸Šä¼ çš„æ–‡ä»¶ï¼š</strong></div>';
                files.forEach(file => {
                    content += `<div style="margin: 5px 0; padding: 5px; background: #f3f4f6; border-radius: 4px;">${file.name}</div>`;
                });
            }
            
            content += '</div>';
            messageDiv.innerHTML = content;
            
            messagesPanel.appendChild(messageDiv);
            messagesPanel.scrollTop = messagesPanel.scrollHeight;
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInputs() {
            feedbackText.value = '';
            uploadedImages = [];
            uploadedFiles = [];
            imageList.innerHTML = '';
            fileList.innerHTML = '';
            imageUpload.value = '';
            fileUpload.value = '';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // å¤åˆ¶å›¾ç‰‡åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG' && e.target.classList.contains('image-preview')) {
                // åˆ›å»ºä¸´æ—¶ canvas æ¥å¤åˆ¶å›¾ç‰‡
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(blob) {
                        navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]).then(() => {
                            showStatus('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                        }).catch(() => {
                            showStatus('å¤åˆ¶å¤±è´¥', 'error');
                        });
                    });
                };
                
                img.src = e.target.src;
            }
        });
    </script>
</body>
</html>